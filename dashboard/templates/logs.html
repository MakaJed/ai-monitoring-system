<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Logs & Analytics - Hensight</title>
  <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}" />
  <style>
    body { background: var(--bg); }
    
    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .logs-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    
    .log-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: var(--panel);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    
    .log-table th {
      background: var(--bg-secondary);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    
    .log-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
      background: var(--panel);
    }
    
    .log-table tbody tr {
      transition: background 0.15s ease;
    }
    
    .log-table tbody tr:hover {
      background: var(--bg);
    }
    
    .log-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .log-timestamp {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .log-metric {
      text-align: right;
      font-weight: 500;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .status-normal { background: #d1fae5; color: #065f46; }
    .status-warning { background: #fed7aa; color: #9a3412; }
    .status-critical { background: #fee2e2; color: #991b1b; }
    
    .symptoms-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent-hover);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      margin: 2px 4px 2px 0;
    }
    
    .btn-view {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .page-info {
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Modal - consistent with dashboard */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 6px 20px var(--shadow);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-weight: 600;
    }
    
    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    @media (max-width: 768px) {
      .modal-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .modal-image-container {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .modal-image-container img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .modal-image-label {
      padding: 6px 8px;
      background: #f8fafc;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    
    .chart-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    
    .chart-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .loading, .empty-state {
      text-align: center;
      padding: 24px;
      color: var(--muted);
      font-size: 13px;
    }
    
    .checkbox-cell {
      width: 32px;
      text-align: center;
    }
    
    /* Mobile responsive for logs table */
    @media (max-width: 768px) {
      .log-table {
        font-size: 12px;
      }
      
      .log-table th,
      .log-table td {
        padding: 6px 4px;
      }
      
      .logs-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .logs-header h2 {
        font-size: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .log-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .log-table thead,
      .log-table tbody,
      .log-table tr,
      .log-table th,
      .log-table td {
        display: block;
      }
      
      .log-table thead {
        display: none;
      }
      
      .log-table tr {
        margin-bottom: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px;
        background: var(--panel);
      }
      
      .log-table td {
        border: none;
        padding: 4px 0;
        text-align: left !important;
      }
      
      .log-table td:before {
        content: attr(data-label) ": ";
        font-weight: 600;
        display: inline-block;
        min-width: 100px;
      }
      
      .checkbox-cell {
        display: none;
      }
    }
  </style>
</head>
<body>
  <nav class="topbar">
    <div class="brand">
      <img src="/static/images/logo.png" alt="Hensight Logo" class="brand-logo" />
      <div class="brand-text">
        <div class="title">Hensight</div>
        <div class="subtitle">Logs & Analytics</div>
      </div>
    </div>
    <div class="top-actions">
      <a class="btn" href="/">Dashboard</a>
    </div>
  </nav>

  <main class="grid" style="grid-template-columns: 1fr;">
    <section class="panel">
      <div class="logs-header">
        <h2 style="margin: 0; font-size: 18px;">Detection Logs</h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button id="delete-selected" class="btn btn-outline" style="font-size: 12px;">Delete Selected</button>
          <span id="selected-count" class="page-info">0 selected</span>
        </div>
      </div>
      <div id="logs-cards" class="loading">Loading logs...</div>
      <div class="pagination">
        <button id="prev" class="btn btn-outline">← Prev</button>
        <div id="page-info" class="page-info">-</div>
        <button id="next" class="btn btn-outline">Next →</button>
      </div>
    </section>

    <section class="panel">
      <h2 style="margin: 0 0 12px 0; font-size: 18px;">Analytics</h2>
      <div class="charts-grid" id="charts">
        <div class="chart-card"><div class="chart-title">Temperature Trend (°C)</div><canvas id="chart-temp" width="560" height="220"></canvas></div>
        <div class="chart-card"><div class="chart-title">Humidity (%) & Gas (kΩ)</div><canvas id="chart-hg" width="560" height="220"></canvas></div>
        <div class="chart-card"><div class="chart-title">Environment Status Summary</div><canvas id="chart-status" width="560" height="220"></canvas></div>
        <div class="chart-card"><div class="chart-title">Symptom Detections Over Time</div><canvas id="chart-sym" width="560" height="220"></canvas></div>
      </div>
    </section>
  </main>

  <!-- Image Modal -->
  <div id="img-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detection Images</h3>
        <button id="img-close" class="btn btn-outline" style="padding: 4px 8px;">Close</button>
      </div>
      <div class="modal-grid">
        <div class="modal-image-container">
          <img id="img-visible" src="" alt="Visible image" style="display: none;" />
          <div id="cap-visible" class="modal-image-label" style="display: none;"></div>
        </div>
        <div class="modal-image-container">
          <img id="img-thermal" src="" alt="Thermal image" style="display: none;" />
          <div id="cap-thermal" class="modal-image-label" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/charts.js?v={{ cache_bust }}"></script>
  <script>
  (function(){
    const cards = document.getElementById('logs-cards');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const pageInfo = document.getElementById('page-info');
    const imgModal = document.getElementById('img-modal');
    const imgVisible = document.getElementById('img-visible');
    const imgThermal = document.getElementById('img-thermal');
    const capVisible = document.getElementById('cap-visible');
    const capThermal = document.getElementById('cap-thermal');
    const imgClose = document.getElementById('img-close');

    let page = 1; const pageSize = 20;

    function openImgs(vp, tp, ts){
      if (vp) {
        imgVisible.src = vp;
        imgVisible.style.display = 'block';
        capVisible.textContent = `Visible — ${ts}`;
        capVisible.style.display = 'block';
      } else {
        imgVisible.style.display = 'none';
        capVisible.style.display = 'none';
      }
      
      if (tp) {
        imgThermal.src = tp;
        imgThermal.style.display = 'block';
        capThermal.textContent = `Thermal — ${ts}`;
        capThermal.style.display = 'block';
      } else {
        imgThermal.style.display = 'none';
        capThermal.style.display = 'none';
      }
      
      imgModal.classList.add('active');
    }
    
    imgClose.addEventListener('click', ()=>{
      imgModal.classList.remove('active');
      imgVisible.src = '';
      imgThermal.src = '';
      imgVisible.style.display = 'none';
      imgThermal.style.display = 'none';
      capVisible.textContent = '';
      capThermal.textContent = '';
      capVisible.style.display = 'none';
      capThermal.style.display = 'none';
    });
    
    imgModal.addEventListener('click', (e)=>{
      if(e.target === imgModal){
        imgClose.click();
      }
    });

    async function loadLogs(){
      try{
        const r = await fetch(`/api/logs?page=${page}&page_size=${pageSize}`);
        const d = await r.json();
        const totalPages = Math.max(1, Math.ceil((d.total||0)/(d.page_size||pageSize)));
        pageInfo.textContent = `Page ${d.page} / ${totalPages} (${d.total||0} total)`;
        prev.disabled = page <= 1;
        next.disabled = page >= totalPages;
        
        if ((d.items||[]).length === 0) {
          cards.innerHTML = '<div class="empty-state">No logs found</div>';
          return;
        }
        
        const html = `
          <table class="log-table">
            <thead>
              <tr>
                <th class="checkbox-cell"><input type="checkbox" id="select-all" /></th>
                <th>Timestamp</th>
                <th>Status</th>
                <th style="text-align: right;">Temp (°C)</th>
                <th style="text-align: right;">Humidity (%)</th>
                <th style="text-align: right;">Gas (kΩ)</th>
                <th style="text-align: right;">Pressure (hPa)</th>
                <th>Symptoms</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${(d.items||[]).map(item=>{
                const status = (item.has_abnormality ? (item.status_level||'warning') : 'normal');
                const cls = status==='critical' ? 'status-critical' : status==='warning' ? 'status-warning' : 'status-normal';
                const sym = item.symptoms_detected || '';
                const symptomsHtml = sym !== '' && sym.trim() ? 
                  sym.split(',').map(s => `<span class="symptoms-badge">${s.trim()}</span>`).join('') : 
                  '<span style="color: var(--muted); font-size: 11px;">-</span>';
                const hasImages = item.image_path_visible || item.image_path_thermal;
                const viewBtn = hasImages ? 
                  `<button class="btn btn-view" onclick="window.openImgs('${item.image_path_visible||''}','${item.image_path_thermal||''}','${item.timestamp||''}');">View</button>` : 
                  '<span style="color: var(--muted); font-size: 11px;">-</span>';
                
                return `<tr>
                  <td class="checkbox-cell"><input type="checkbox" class="sel" data-id="${item.id}" /></td>
                  <td data-label="Timestamp"><div class="log-timestamp">${item.timestamp || 'Unknown'}</div></td>
                  <td data-label="Status"><span class="status-badge ${cls}">${status.charAt(0).toUpperCase()+status.slice(1)}</span></td>
                  <td class="log-metric" data-label="Temp (°C)">${item.bme_temp ?? '-'}</td>
                  <td class="log-metric" data-label="Humidity (%)">${item.bme_humidity ?? '-'}</td>
                  <td class="log-metric" data-label="Gas (kΩ)">${item.bme_gas ? (item.bme_gas / 1000).toFixed(1) : '-'}</td>
                  <td class="log-metric" data-label="Pressure (hPa)">${item.bme_pressure ?? '-'}</td>
                  <td data-label="Symptoms">${symptomsHtml}</td>
                  <td data-label="Actions">${viewBtn}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        `;
        cards.innerHTML = html;
        
        // Select all checkbox
        document.getElementById('select-all')?.addEventListener('change', (e)=>{
          document.querySelectorAll('.sel').forEach(cb => cb.checked = e.target.checked);
          updateSelectedCount();
        });
        
        window.openImgs = openImgs;
        updateSelectedCount();
      }catch(e){ 
        cards.innerHTML = '<div class="empty-state">Failed to load logs</div>';
      }
    }

    async function loadSummaries(){
      try{
        const r = await fetch('/api/summaries');
        const d = await r.json();
        const daily = d.daily||[];
        const labels = daily.map(x=>x.day);
        const temps = daily.map(x=>x.avg_temp ?? null);
        const hums  = daily.map(x=>x.avg_humidity ?? null);
        const gas   = daily.map(x=>x.avg_gas ?? null);
        const statusCounts = ['normal','warning','critical'].map(k=> (d.status_counts && d.status_counts[k]) || 0);
        const symCounts = daily.map(x=>x.symptom_count || 0);
        drawLineChart('chart-temp', labels, temps, '#16a34a', 'Temperature Trend (°C)');
        drawDualAxis('chart-hg', labels, hums, gas, '#0ea5e9', '#f59e0b', 'Humidity (%)', 'Gas (kΩ)');
        drawDonut('chart-status', statusCounts, ['#16a34a','#f97316','#ef4444'], ['Normal','Warning','Critical']);
        drawBarChart('chart-sym', labels, symCounts, '#a855f7', 'Symptoms per Day');
      }catch(e){ 
        document.getElementById('charts').innerHTML = '<div class="empty-state">Failed to load analytics</div>';
      }
    }

    function getSelectedIds(){
      return Array.from(document.querySelectorAll('.sel:checked')).map(x=>parseInt(x.getAttribute('data-id'))).filter(Boolean);
    }
    function updateSelectedCount(){
      const sel = getSelectedIds();
      document.getElementById('selected-count').textContent = `${sel.length} selected`;
    }
    document.addEventListener('change', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('sel')) updateSelectedCount(); });

    document.getElementById('delete-selected').addEventListener('click', async ()=>{
      const ids = getSelectedIds();
      if(ids.length === 0) return;
      if(!confirm(`Delete ${ids.length} log entry(ies)?`)) return;
      try{
        const r = await fetch('/api/logs/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids})});
        const d = await r.json();
        if(d.ok){ loadLogs(); }
      }catch(e){ alert('Failed to delete logs'); }
    });

    prev.addEventListener('click', ()=>{ if(page > 1) { page--; loadLogs(); } });
    next.addEventListener('click', ()=>{ page++; loadLogs(); });

    loadLogs(); loadSummaries();
  })();
  </script>
</body>
</html>
